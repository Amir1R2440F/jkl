#!/bin/sh

set -euf

DIR=${1:-}
CMD=${2:-}

if [ x$DIR = "x" ]
then
	DIR="."
fi

if [ ! -d "${DIR}/.git/" ]
then
	exit 1
fi

#
# Locate the closest annotated tag
#
REVISION="$(git describe --abbrev=0 --tags)"

#
# Determine if we are a development branch, if so then append the
# short SHA1.
#
EXACTLY="$(git describe --abbrev=0 --tags --exact-match 2>/dev/null || echo)"

if test -z "$EXACTLY"; then
    REVISION="${REVISION}_rev-$(git rev-parse --verify --short HEAD)"
fi

if test "x$CMD" = "xquoted"; then
    echo \"$REVISION\"
else
    echo $REVISION
fi
